<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="FundingMainMapper">
	<!-- 메인 페이지 리스트 출력 -->
	<select id="listDog" parameterType="com.edu.vo.Pagination" resultType="FundingMainVO">
		SELECT funding_idx,
			funding_title,
			funding_thumbnail,
			funding_target_price,
			funding_current_price,
			funding_start_date,
			funding_end_date,
			funding_permit_state,
			funding_current_state,
			funding_category,
			funding_views
		FROM funding
		where funding_category=0
		order by funding_idx desc limit #{rowStart}, 9;
	</select>
	<select id="listCat" parameterType="com.edu.vo.Pagination" resultType="FundingMainVO">
		SELECT funding_idx,
			funding_title,
			funding_thumbnail,
			funding_target_price,
			funding_current_price,
			funding_start_date,
			funding_end_date,
			funding_permit_state,
			funding_current_state,
			funding_category,
			funding_views
		FROM funding
		where funding_category=1
		order by funding_idx desc limit #{rowStart}, 9;
	</select>	
	<select id="listOther" parameterType="com.edu.vo.Pagination" resultType="FundingMainVO">
		SELECT funding_idx,
			funding_title,
			funding_thumbnail,
			funding_target_price,
			funding_current_price,
			funding_start_date,
			funding_end_date,
			funding_permit_state,
			funding_current_state,
			funding_category,
			funding_views
		FROM funding
		where funding_category=2
		order by funding_idx desc limit #{rowStart}, 9;
	</select>
	
	<!-- 카테고리 별 상품 수 -->
	<select id="listDogCount" resultType="int">
		SELECT COUNT(funding_idx)
		FROM funding
		where funding_category=0 AND funding_current_state=1;
	</select>
	<select id="listCatCount" resultType="int">
		SELECT COUNT(funding_idx)
		FROM funding
		where funding_category=1 AND funding_current_state=1;
	</select>
	<select id="listOtherCount" resultType="int">
		SELECT COUNT(funding_idx)
		FROM funding
		where funding_category=2 AND funding_current_state=1;
	</select>
	
	
	<!-- 글 조회하기 -->
	<select id="read" parameterType="int" resultType="FundingMainVO">
		SELECT funding_idx,
			funding_title,
			funding_thumbnail,
			funding_content,
			funding_notice,
			funding_target_price,
			funding_current_price,
			funding_start_date,
			funding_end_date,
			funding_permit_state,
			funding_current_state,
			funding_category
		FROM funding
		where funding_idx = #{funding_idx}
	</select>
	
	<!-- 조회수 증가 -->
	<update id="fundingViews" parameterType="int">
		UPDATE funding SET
		funding_views = funding_views+1
		WHERE funding_idx = #{funding_idx}
	</update>
	
	<!-- 펀딩 커뮤니티 댓글 리스트 join을 위한 resultMap -->
	<resultMap type="MemberVO" id="MemberVO">
		<result column="member_name" property="member_name"/>
		<result column="member_photo" property="member_photo"/>
	</resultMap>
	<resultMap type="FundingCommunityVO" id="FundingCommunityVO">
		<result column="funding_detail_community_idx" property="funding_detail_community_idx"/>
		<result column="funding_detail_community_content" property="funding_detail_community_content"/>
		<result column="funding_detail_community_regdate" property="funding_detail_community_regdate"/>
		<result column="funding_detail_community_category" property="funding_detail_community_category"/>
		<result column="funding_idx" property="funding_idx"/>
		<result column="member_idx" property="member_idx"/>
		<collection property="memberVO" resultMap="MemberVO"></collection>
	</resultMap>
	
	<!-- 펀딩 커뮤니티 댓글 리스트 -->
	<select id="readFundingCommunityComment" resultType="FundingCommunityVO" parameterType="FundingCommunityVO" resultMap="FundingCommunityVO">
		select 
			commu.funding_detail_community_idx,
			commu.funding_detail_community_content,
			commu.funding_detail_community_regdate,
			commu.funding_detail_community_category,
			commu.funding_idx,
			commu.member_idx,
			mem.member_name,
			mem.member_photo
		FROM funding_detail_community AS commu
		JOIN member AS mem 
		ON commu.funding_idx = #{funding_idx} and commu.member_idx = mem.member_idx
		order by funding_detail_community_idx desc;
	</select>
	
	<!-- 펀딩 커뮤니티 댓글 작성 -->
	<insert id="writeFundingCommunityComment" parameterType="FundingCommunityVO">
		INSERT INTO funding_detail_community
			(
				funding_idx,
				member_idx,
				funding_detail_community_content,
				funding_detail_community_category
			)
		VALUES
			(
				#{funding_idx},
				#{member_idx},
				#{funding_detail_community_content},
				#{funding_detail_community_category}
			)	
	</insert>
	
	
	<!-- 펀딩 옵션 리스트 -->
	<select id="list" resultType="Funding_optionVO">
		SELECT funding_idx,
			   funding_option_idx,
			   funding_option_name,
			   funding_option_price,
			   funding_option_detail,
			   funding_option_stock
		  FROM funding_option
		 WHERE funding_idx = 1;
	</select>
	
	
	<!-- 펀딩 등록 하기 -->
	<insert id="Funding_reg" parameterType="fundingMainVO">
		INSERT INTO funding(
		 member_idx
		,funding_title
		,funding_thumbnail
		,funding_content
		,funding_notice
		,funding_target_price
		,funding_current_price
		,funding_start_date
		,funding_end_date
		,funding_permit_state
		,funding_current_state
		,funding_category
		,funding_express_date
		,funding_express_fee
		,funding_views
		)
		VALUES(
		#{member_idx}
		,#{funding_title}
		,#{funding_thumbnail}
		,#{funding_content}
		,#{funding_notice}
		,#{funding_target_price}
		,#{funding_current_price}
		,#{funding_start_date}
		,#{funding_end_date}
		,#{funding_permit_state}
		,#{funding_current_state}
		,#{funding_category}
		,#{funding_express_date}
		,#{funding_express_fee}
		,#{funding_views}
		)
		
		
	
	
	
	</insert>
	
</mapper>