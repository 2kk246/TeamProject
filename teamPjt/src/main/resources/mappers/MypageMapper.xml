<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MypageMapper">
	
	<!-- 프로필 사진 업데이트 -->
	<update id="update_photo" parameterType="fileuploadVO">
		UPDATE member
		SET    member_photo = #{path}
		WHERE  member_idx = #{member_idx}
	</update>
	
	<!-- 프로필 업데이트 -->
	<update id="update_profile" parameterType="memberVO">
		UPDATE 	member
		SET	   	member_addr = #{member_addr},
				member_addr2 = #{member_addr2},
				member_postnum = #{member_postnum},
			 	member_phone = #{member_phone},
			 	member_pet = #{member_pet},
	<if test="member_password != null and member_password neq ''">
				member_password = #{member_password}
	</if>
		WHERE  	member_idx = #{member_idx}
	</update>
	
	<!-- 아이디 찾기 MypageController2 -->
	<select id="findId" resultType="String">
		SELECT member_email
		FROM   member
	    WHERE  member_name = #{member_name}
	   	AND    member_phone = #{member_phone}
	</select>
	
	<!-- 비밀번호 찾기 MypageController2 (필요없음, 나중에 삭제할것)-->
	<select id="findPw" resultType="String">
		SELECT member_password
		FROM   member
	    WHERE  member_name = #{member_name}
	   	AND    member_phone = #{member_phone}
	   	AND	   member_email = #{member_email}
	</select>
	
	<!-- 비밃번호 변경 MypageController2 -->
	<update id="changePw" parameterType="changePwVO">
		UPDATE member 
		SET    member_password = ifnull(#{changedPw},0)
		WHERE  member_email = #{member_email}
		AND    member_name = #{member_name}
		AND    member_phone = #{member_phone}
	</update>
	
	<!-- mypage1 펀딩 리스트 출력 3개 -->
	<select id="select3Funding" parameterType="int" resultType="FundingMainVO">
		SELECT  f.funding_idx,
				f.funding_title,
				f.funding_thumbnail,
				f.funding_target_price,
				f.funding_current_price,
				f.funding_start_date,
				f.funding_end_date,
				f.funding_permit_state,
				f.funding_current_state,
				f.funding_category,
				f.funding_views
		FROM  	funding_order fo, funding f 
		WHERE 	fo.funding_idx = f.funding_idx 
		AND 	fo.member_idx = #{member_idx}
		ORDER BY fo.funding_order_date DESC limit 3;
	</select>
	
	<!-- mypage1 펀딩 개수 -->
	<select id="countFunding" parameterType="int" resultType="int">
		SELECT	count(f.funding_idx)
		FROM  	funding_order fo, funding f 
		WHERE 	fo.funding_idx = f.funding_idx 
		AND 	fo.member_idx = #{member_idx}
	</select>
	
	<!-- 펀딩 내역 -->
	<select id="myFundingList" parameterType="int" resultType="FundingMainVO">
		SELECT 	f.funding_idx,
				f.funding_title,
				f.funding_thumbnail,
				f.funding_target_price,
				f.funding_current_price,
				f.funding_start_date,
				f.funding_end_date,
				f.funding_permit_state,
				f.funding_current_state,
				f.funding_category,
				f.funding_views,
				fo.funding_order_date
		FROM  	funding_order fo, funding f 
		WHERE 	fo.funding_idx = f.funding_idx 
		AND 	fo.member_idx=#{member_idx}
		ORDER BY fo.funding_order_date DESC
	</select>
	
	
	<!-- mypage1 찜 리스트 출력 3개  -->
	<select id="select3Zzim" parameterType="int" resultType="FundingMainVO">
		SELECT  f.funding_idx,
				f.funding_title,
				f.funding_thumbnail,
				f.funding_target_price,
				f.funding_current_price,
				f.funding_start_date,
				f.funding_end_date,
				f.funding_permit_state,
				f.funding_current_state,
				f.funding_category,
				f.funding_views
		FROM  	zzim z, funding f 
		WHERE	z.funding_idx = f.funding_idx 
		AND	 	z.member_idx = #{member_idx} 
		ORDER BY z.zzim_idx DESC limit 3;
	</select>
	
	<!-- mypage1 찜 갯수 -->
	<select id="countZzim" parameterType="int" resultType="int">
		SELECT  count(z.zzim_idx)
		FROM    zzim z, funding f 
		WHERE 	z.funding_idx = f.funding_idx 
		AND	 	z.member_idx = #{member_idx} 
	</select>
	
	<!-- 찜 내역 -->
	<select id="myZzimList" parameterType="int" resultType="FundingMainVO">
		SELECT	f.funding_idx,
				f.funding_title,
				f.funding_thumbnail,
				f.funding_target_price,
				f.funding_current_price,
				f.funding_start_date,
				f.funding_end_date,
				f.funding_permit_state,
				f.funding_current_state,
				f.funding_category,
				f.funding_views
		FROM 	zzim z, funding f 
		WHERE 	z.funding_idx = f.funding_idx 
		AND 	z.member_idx = #{member_idx} 
		ORDER BY z.zzim_idx DESC
	</select>
	
	<!-- mypage2 내 펀딩 내역 -->
	<select id="sellerFundingList" parameterType="int" resultType="FundingMainVO">
		SELECT 	f.funding_idx,
				f.funding_title,
				f.funding_thumbnail,
				f.funding_target_price,
				f.funding_current_price,
				f.funding_start_date,
				f.funding_end_date,
				f.funding_content,
				f.funding_permit_state,
				f.funding_current_state,
				f.funding_category,
				f.funding_views 
		FROM    funding f 
		WHERE   f.member_idx = #{member_idx}
	</select>
	
	<!-- funding_info_detail -->
	<select id="fundingInfoDetail" parameterType="com.edu.vo.FundingInfoDetailParameterVO" resultType="com.edu.vo.FundingInfoDetailVO">
		SELECT 	fo.funding_order_idx, 
				fo.funding_order_date,
				fo.funding_order_total_price,
				fo.funding_order_pay_state,
				f.funding_idx,
				f.funding_title,
				f.funding_thumbnail,
				f.funding_target_price,
				f.funding_current_price,
				f.funding_start_date,
				f.funding_end_date,
				f.funding_content,
				f.funding_permit_state,
				f.funding_current_state,
				f.funding_category,
				f.funding_views,
				f.funding_express_date,
				f.funding_express_fee
		FROM 	funding_order fo, funding f 
		WHERE	fo.funding_idx = f.funding_idx 
		AND 	f.funding_idx = #{funding_idx}
		AND		fo.member_idx = #{member_idx}
	</select>
	
	<!-- 찜 취소 -->
	<delete id="deleteZzim" parameterType="java.util.HashMap">
		DELETE FROM zzim
		WHERE funding_idx = #{funding_idx} AND member_idx = #{member_idx};
	</delete>
	
</mapper>